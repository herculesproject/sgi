# Notas de Actualización: 1.0.0

> **Fecha:** 2026-02-26
>
> **Versión anterior:** 20250724
>
> [Resumen de cambios (CHANGELOG)](../../CHANGELOG.md#100-2026-02-26) | [Guía de despliegue del SGI con Helm](common/deployment.md)

## Acciones previas al despliegue

<!--
  Listar acciones obligatorias que deben realizarse ANTES de lanzar la actualización.
  Incluye:
  - Breaking Changes que requieren intervención manual.
  - Ejecución de scripts de migración manuales o limpieza de datos.
  - Generación de backups específicos si la actualización es crítica.
  
  Si no hay acciones previas, indicar: "No se requieren acciones previas para esta versión."
-->

### Migración del repositorio Helm

El repositorio de Helm Charts anterior ha dejado de recibir mantenimiento. El [nuevo repositorio](https://herculesproject.github.io/sgi-helm) es compatible con las instalaciones existentes, permitiendo transiciones transparentes mediante el comando `helm upgrade` sin necesidad de realizar cambios adicionales.

Actualizar la referencia del repositorio local:

```bash
# Comprobar el nombre del repo anterior
helm repo list
# NAME                      URL 
# sgi-helm                  https://hercules-sgi.github.io/sgi-helm/   

# Eliminar el repositorio antiguo
helm repo remove sgi-helm

# Añadir el repositorio actual
helm repo add sgi-helm https://herculesproject.github.io/sgi-helm

# Actualizar información de repositorios
helm repo update
```


## Configuración

### 1. Unificación de versiones

Se centraliza la gestión de versiones de las imágenes de los servicios SGI, permitiendo definir una versión global en lugar de configuraciones individuales.

#### Configuración global

Definir la versión y política de descarga comunes bajo la clave `global` en el archivo `values.yaml`:

```yaml
global:
  image:
    # Versión global aplicable a todos los servicios
    tag: 1.0.0
    # Política de descarga por defecto
    pullPolicy: IfNotPresent
```

#### Prioridad de configuración
Los valores definidos a nivel de servicio (`service-name.image.tag`) tienen prioridad sobre la configuración global. Para que el versionado centralizado sea efectivo, es necesario eliminar las definiciones específicas de `tag` y `pullPolicy` en cada servicio.

#### Compatibilidad con gestión individual
El método de actualización individual por servicio sigue siendo totalmente funcional. Se puede optar por no usar la clave `global` y continuar especificando la versión deseada en cada componente de forma independiente.

#### Servicios de integración
No es necesario realizar ninguna modificación si no despliegan mediante los el SGI.

Cuando el despliegue se realiza utilizando el chart del SGI, se recomienda conservar sus definiciones de `tag` (y `pullPolicy`, si difiere del valor global) ya que estos componentes suelen seguir un ciclo de vida de versiones distinto al núcleo del SGI.


### 2. Migración del repositorio de imágenes Docker

Las imágenes de los servicios del **SGI** se han migrado a una nueva organización en Docker Hub y se ha estandarizado la nomenclatura de las imágenes añadiendo el prefijo `sgi-` a todos los servicios.

#### Cambio de organización

- **Organización anterior**: [h3rcul3scru3](https://hub.docker.com/u/h3rcul3scru3)
- **Organización actual**: [herculesproject](https://hub.docker.com/u/herculesproject)

#### Nomenclatura de imágenes

| Componente      | Imagen anterior                       | Imagen actual                                       |
|-----------------|---------------------------------------|-----------------------------------------------------|
| sgdoc-service   | `h3rcul3scru3/sgdoc-service`          | `herculesproject/sgi-external-sgdoc-reference-imp`  |
| sgi-cnf-service | `h3rcul3scru3/cnf-service`            | `herculesproject/sgi-cnf-service`                   |
| sgi-com-service | `h3rcul3scru3/com-service`            | `herculesproject/sgi-com-service`                   |
| sgi-csp-service | `h3rcul3scru3/csp-service`            | `herculesproject/sgi-csp-service`                   |
| sgi-eer-service | `h3rcul3scru3/eer-service`            | `herculesproject/sgi-eer-service`                   |
| sgi-eti-service | `h3rcul3scru3/eti-service`            | `herculesproject/sgi-eti-service`                   |
| sgi-keycloak    | `h3rcul3scru3/auth`                   | `herculesproject/sgi-auth`                          |
| sgi-pii-service | `h3rcul3scru3/pii-service`            | `herculesproject/sgi-pii-service`                   |
| sgi-prc-service | `h3rcul3scru3/prc-service`            | `herculesproject/sgi-prc-service`                   |
| sgi-rel-service | `h3rcul3scru3/rel-service`            | `herculesproject/sgi-rel-service`                   |
| sgi-rep-service | `h3rcul3scru3/rep-service`            | `herculesproject/sgi-rep-service`                   |
| sgi-tp-service  | `h3rcul3scru3/tp-service`             | `herculesproject/sgi-tp-service`                    |
| sgi-usr-service | `h3rcul3scru3/usr-service`            | `herculesproject/sgi-usr-service`                   |
| sgi-webapp      | `h3rcul3scru3/sgi-webapp`             | `herculesproject/sgi-webapp`                        |


#### Actualización del fichero values.yaml

Actualizar `<service-name>.image.repository` de cada servicio en el fichero `values.yaml` con el valor correspondiente de la columna **"Imagen actual"** de la tabla anterior.

```yaml
# Ejemplo de actualización
sgi-com-service:
  image:
    repository: herculesproject/sgi-com-service
```

Para nuevas instalaciones, el `values.yaml` del chart de la versión actual ya incluye las referencias a las imágenes actualizadas.

### 3. Keycloak (sgi-auth)

Añadida la opción de personalizar la configuración del realm de Keycloak para el **despliegue inicial** (secrets de los clients, usuarios, roles, etc.).

Procedimiento de configuración:

1. Adaptar el realm incluido en el `sgi-auth`: [sgi-realm.json](/sgi-auth/realm/sgi-realm.json).
2. Crear el ConfigMap:
    ```bash
    # Generar ConfigMap a partir del fichero local
    kubectl create configmap custom-sgi-realm --from-file=sgi-realm.json=./sgi-realm.json -n <namespace>
    ```
3. Actualizar el `values.yaml` para utilizar el ConfigMap personalizado:
    ```yaml
    sgi-keycloak:
      realmConfigMap:
        enabled: true
        name: "custom-sgi-realm"
        key: "sgi-realm.json"
    ```
4. Después de completar el despliegue inicial se puede eliminar el ConfigMap utilizado para la importación:  
    ```bash
    kubectl delete configmap custom-sgi-realm -n <namespace>
    ```

Esta configuración solo se utiliza durante la **instalación inicial**. Una vez que Keycloak ha sido inicializado, los cambios deben realizarse desde la interfaz de administración de Keycloak.

Si no se define un ConfigMap personalizado, se utilizará la configuración por defecto incluida en `sgi-auth`.

### 4. Actualización y rotación de secretos

Se recomienda realizar una rotación completa de todos los secrets de los clientes de Keycloak como medida de seguridad preventiva tras la resolución de la vulnerabilidad [CVE-2020-27838](https://nvd.nist.gov/vuln/detail/CVE-2020-27838) (la vulnerabilidad solo afecta si clientes publicos se convierten en confidenciales).

Para más detalles, consultar la [Guía de Rotación de Claves y Secretos del SGI](/sgi-auth/docs/keycloak-secrets-rotation.md).

#### Procedimiento de rotación
Para actualizar el secret de los clients de Keycloak utilizados por los servicios SGI, debe modificarse el valor correspondiente en la sección `extraEnvVariables` del fichero `values.yaml`.

**Ejemplo de configuración:**
```yaml
# Client secret en texto plano (no recomendado)
sgi-com-service:
  extraEnvVariables:
    - name: SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_COM-SERVICE_CLIENT-SECRET
      value: "nuevo-secret-xxxx-xxxx"

# Client secret desde un Secret
sgi-com-service:
  extraEnvVariables:
    - name: SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_COM-SERVICE_CLIENT-SECRET
      valueFrom:
        secretKeyRef:
          name: sgi-keycloak-clients-secret
          key: com_service_client_secret
```

#### Relación de servicios y variables a revisar

| Servicio             | Variable de entorno (client secret)                                    |
| -------------------- | ---------------------------------------------------------------------- |
| **sgi-com-service**  | `SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_COM-SERVICE_CLIENT-SECRET` |
| **sgi-csp-service**  | `SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_CSP-SERVICE_CLIENT-SECRET` |
| **sgi-eti-service**  | `SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_ETI-SERVICE_CLIENT-SECRET` |
| **sgi-pii-service**  | `SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_PII-SERVICE_CLIENT-SECRET` |
| **sgi-prc-service**  | `SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_PRC-SERVICE_CLIENT-SECRET` |
| **sgi-rep-service**  | `SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_REP-SERVICE_CLIENT-SECRET` |
| **sgi-tp-service**   | `SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_TP-SERVICE_CLIENT-SECRET`  |
| **sgp-service***     | `SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_SGP-SERVICE_CLIENT-SECRET` |

(*) El servicio **sgp-service** solo debe revisarse si forma parte del despliegue y utiliza el client de Keycloak del SGI. En caso contrario, no es necesario realizar ninguna acción.

### 5. Ampliar permisos para administradores CSP

En nuevas instalaciones, los grupos de administradores del módulo CSP incluyen ahora también los permisos del grupo `SYSADM-CSP` para que tengan disponibles todas las opciones del menú configuración de **CSP**.

Este cambio **no se aplica automáticamente** en instalaciones existentes. Valorar en cada caso si se debe realizar el cambio.


#### Grupos afectados

Este cambio aplica al grupo `ADMINISTRADOR-CSP` y sus variantes con el patrón `ADMINISTRADOR-CSP-UNIDAD_GESTION`.

#### Roles añadidos

Los siguientes roles de configuración de CSP se han añadido a los grupos mencionados:

- Roles de equipo:
  - `CSP-ROLE-B`, `CSP-ROLE-C`, `CSP-ROLE-E`, `CSP-ROLE-R`
- Roles de socio de proyecto:
  - `CSP-ROLS-B`, `CSP-ROLS-C`, `CSP-ROLS-E`, `CSP-ROLS-R`
- Tipos de ámbito geográfico:
  - `CSP-TAGE-B`, `CSP-TAGE-C`, `CSP-TAGE-E`, `CSP-TAGE-R`
- Tipos de facturación:
  - `CSP-TFAC-B`, `CSP-TFAC-C`, `CSP-TFAC-E`, `CSP-TFAC-R`
- Tipos de origen de fuente de financiación:
  - `CSP-TOFF-B`, `CSP-TOFF-C`, `CSP-TOFF-E`, `CSP-TOFF-R`
- Tipos de régimen de concurrencia:
  - `CSP-TRCO-B`, `CSP-TRCO-C`, `CSP-TRCO-E`, `CSP-TRCO-R`

#### Aplicación manual en instalaciones existentes

Para aplicar este cambio al realizar la actualización:
1. Acceder a la **consola de administración de Keycloak**.
2. Seleccionar el realm **SGI**.
3. Navegar a **Groups**.
4. Para cada grupo afectado (`ADMINISTRADOR-CSP`, `ADMINISTRADOR-CSP-OPE`, ...):
   - Ir a la pestaña **Role Mappings**.
   - Seleccionar en **Available Roles** los roles listados anteriormente.
   - Hacer clic en **Add selected**.


## Cambios en base de datos

Lista de servicios que incluyen cambios en el modelo de datos y/o actualizaciones de datos:

| Servicio | Path cambios | Descripción |
|---|---|---|
| sgi-cnf-service | [sgi-cnf-service/src/main/resources/db/changelog/changes/0.9.0](../../sgi-cnf-service/src/main/resources/db/changelog/changes/0.9.0) | Actualización de plantillas de informes ETI y CSP en tabla `resources`. El cambio solo se aplica automáticamente si el valor de la columna `value` coincide con `default_value`. |
| sgi-com-service | [sgi-com-service/src/main/resources/db/changelog/changes/0.6.0](../../sgi-com-service/src/main/resources/db/changelog/changes/0.6.0) | Actualización de la plantilla de comunicado `CSP_COM_INICIO_PRESENTACION_GASTO`. El cambio solo se aplica automáticamente si el valor de la columna `tpl_text` coincide con `default_tpl_text`. |
| sgi-eti-service | [sgi-eti-service/src/main/resources/db/changelog/changes/0.8.0](../../sgi-eti-service/src/main/resources/db/changelog/changes/0.8.0) | Creación de nuevas versiones de formularios (M10, M20, M30, SA, SF, R). Los nuevos formularios solo se asignan automáticamente a los comités en entornos de desarrollo (`context="dev"`). |

Tras completar el proceso de actualización, se recomienda revisar los cambios que no se aplicaron automáticamente (plantillas personalizadas, asignación de formularios a comités, etc.) para determinar si es necesario incorporar manualmente las modificaciones introducidas en esta versión sobre las versiones personalizadas existentes.


## Procedimiento de actualización

1. Aplicar en los ficheros `values.yaml` de cada entorno los cambios de configuración descritos en la sección [Configuración](#configuración).
2. Ejecutar el despliegue siguiendo el [procedimiento estándar](common/deployment.md), utilizando el tag de la versión **`1.0.0`**.

## Validación de la actualización

Tras completar el despliegue, validar que la actualización se ha aplicado correctamente:

1. Verificación de versiones:

    Comprobar que los deployments están utilizando la versión de imagen esperada:

    ```bash
    kubectl get deployments.apps -n <namespace> -o wide
    ```

2. Rotación de secretos:

   Si se realizó la rotación de los secretos de Keycloak, verificar que los servicios se autentican correctamente.

3. Estado de los recursos:

    Verificar que todos los pods asociados al despliegue se encuentran en estado `Running` y `Ready`:

    ```bash
    kubectl get pods -n <namespace>
    ```

4. Validación funcional:

    Confirmar el correcto funcionamiento de los servicios afectados por la actualización, prestando especial atención a los cambios incluidos en el [CHANGELOG](../../CHANGELOG.md#100-2026-02-26) de esta versión.
