<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
  xmlns:pro="http://www.liquibase.org/xml/ns/pro"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd
                      http://www.liquibase.org/xml/ns/pro http://www.liquibase.org/xml/ns/pro/liquibase-pro-3.8.xsd
                      http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">
  <property name="schemaPrefix" value="" />
  <property name="defaultLang" value="es" />

  <changeSet author="user (generated)" id="00.07.00-1">

    <createTable tableName="informe_documento">
      <column name="informe_id" type="BIGINT">
        <constraints nullable="false" />
      </column>
      <column name="lang" type="VARCHAR(2)">
        <constraints nullable="false" />
      </column>
      <column name="documento_ref" type="VARCHAR(250)">
        <constraints nullable="false" />
      </column>
    </createTable>

    <addPrimaryKey tableName="informe_documento" columnNames="informe_id, lang" />

    <addForeignKeyConstraint baseColumnNames="informe_id" baseTableName="informe_documento"
      constraintName="FK_INFORMEDOCUMENTO_INFORME" deferrable="false" initiallyDeferred="false"
      referencedColumnNames="id" referencedTableName="informe" validate="true" />

    <sql>INSERT INTO ${schemaPrefix}informe_documento(informe_id, documento_ref, lang) SELECT id,
      documento_ref, '${defaultLang}' FROM ${schemaPrefix}informe</sql>

    <dropColumn columnName="documento_ref" tableName="informe" />
  </changeSet>

  <changeSet author="user (generated)" id="00.07.00-2">

    <createTable tableName="acta_documento">
      <column name="acta_id" type="BIGINT">
        <constraints nullable="false" />
      </column>
      <column name="lang" type="VARCHAR(2)">
        <constraints nullable="false" />
      </column>
      <column name="documento_ref" type="VARCHAR(250)">
        <constraints nullable="true" />
      </column>
      <column name="transaccion_ref" type="VARCHAR(250)">
        <constraints nullable="true" />
      </column>
    </createTable>

    <addPrimaryKey tableName="acta_documento" columnNames="acta_id, lang" />

    <addForeignKeyConstraint baseColumnNames="acta_id" baseTableName="acta_documento"
      constraintName="FK_ACTADOCUMENTO_ACTA" deferrable="false" initiallyDeferred="false"
      referencedColumnNames="id" referencedTableName="acta" validate="true" />

    <sql>INSERT INTO ${schemaPrefix}acta_documento(acta_id, documento_ref, transaccion_ref, lang)
      SELECT id, documento_ref, transaccion_ref, '${defaultLang}' FROM ${schemaPrefix}acta</sql>

    <dropColumn columnName="documento_ref" tableName="acta" />
    <dropColumn columnName="transaccion_ref" tableName="acta" />

  </changeSet>

  <changeSet author="user (generated)" id="00.07.00-3">

    <createTable tableName="bloque_nombre">
      <column name="bloque_id" type="BIGINT">
        <constraints nullable="false" />
      </column>
      <column name="lang" type="VARCHAR(2)">
        <constraints nullable="false" />
      </column>
      <column name="value_" type="VARCHAR(2000)">
        <constraints nullable="false" />
      </column>
    </createTable>

    <addPrimaryKey tableName="bloque_nombre" columnNames="bloque_id, lang" />

    <addForeignKeyConstraint baseColumnNames="bloque_id" baseTableName="bloque_nombre"
      constraintName="FK_BLOQUENOMBRE_BLOQUE" deferrable="false" initiallyDeferred="false"
      referencedColumnNames="id" referencedTableName="bloque" validate="true" />

    <sql>INSERT INTO ${schemaPrefix}bloque_nombre(bloque_id, value_, lang) SELECT id, nombre,
      '${defaultLang}' FROM ${schemaPrefix}bloque</sql>

    <dropColumn columnName="nombre" tableName="bloque" />
  </changeSet>

  <changeSet author="user (generated)" id="00.07.00-4">

    <createTable tableName="apartado_definicion">
      <column name="apartado_id" type="BIGINT">
        <constraints nullable="false" />
      </column>
      <column name="lang" type="VARCHAR(2)">
        <constraints nullable="false" />
      </column>
      <column name="nombre" type="VARCHAR(250)">
        <constraints nullable="false" />
      </column>
      <column name="esquema" type="CLOB">
        <constraints nullable="false" />
      </column>
    </createTable>

    <addPrimaryKey tableName="apartado_definicion" columnNames="apartado_id, lang" />

    <addForeignKeyConstraint baseColumnNames="apartado_id" baseTableName="apartado_definicion"
      constraintName="FK_APARTADODEFINICION_APARTADO" deferrable="false" initiallyDeferred="false"
      referencedColumnNames="id" referencedTableName="apartado" validate="true" />

    <sql>INSERT INTO ${schemaPrefix}apartado_definicion(apartado_id, nombre, esquema, lang) SELECT
      id, nombre, esquema, '${defaultLang}' FROM ${schemaPrefix}apartado</sql>

    <dropColumn columnName="nombre" tableName="apartado" />
    <dropColumn columnName="esquema" tableName="apartado" />
  </changeSet>

  <changeSet author="user (generated)" id="00.07.00-5">

    <createTable tableName="formly_definicion">
      <column name="formly_id" type="BIGINT">
        <constraints nullable="false" />
      </column>
      <column name="lang" type="VARCHAR(2)">
        <constraints nullable="false" />
      </column>
      <column name="esquema" type="CLOB">
        <constraints nullable="false" />
      </column>
    </createTable>

    <addPrimaryKey
      tableName="formly_definicion" columnNames="formly_id, lang" />

    <addForeignKeyConstraint
      baseColumnNames="formly_id" baseTableName="formly_definicion"
      constraintName="FK_FORMLYDEFINICION_FORMLY" deferrable="false" initiallyDeferred="false"
      referencedColumnNames="id" referencedTableName="formly" validate="true" />

    <sql>INSERT INTO ${schemaPrefix}formly_definicion(formly_id, esquema, lang) SELECT id, esquema,
      '${defaultLang}' FROM ${schemaPrefix}formly</sql>

    <dropColumn
      columnName="esquema" tableName="formly" />

  </changeSet>

  <!-- Petición Evaluacion -->
  <changeSet author="user (generated)" id="00.07.00-6">
    <!-- Título -->
    <createTable tableName="peticion_evaluacion_titulo">
      <column name="peticion_evaluacion_id" type="BIGINT">
        <constraints nullable="false" />
      </column>
      <column name="lang" type="VARCHAR(2)">
        <constraints nullable="false" />
      </column>
      <column name="value_" type="VARCHAR(1000)">
        <constraints nullable="false" />
      </column>
    </createTable>

    <addPrimaryKey tableName="peticion_evaluacion_titulo" columnNames="peticion_evaluacion_id, lang" />

    <addForeignKeyConstraint baseColumnNames="peticion_evaluacion_id"
      baseTableName="peticion_evaluacion_titulo"
      constraintName="FK_PETICIONEVALUACIONTITULO_PETICIONEVALUACION" deferrable="false"
      initiallyDeferred="false"
      referencedColumnNames="id" referencedTableName="peticion_evaluacion" validate="true" />

    <sql>INSERT INTO ${schemaPrefix}peticion_evaluacion_titulo(peticion_evaluacion_id, lang, value_)
      SELECT id, '${defaultLang}', titulo FROM ${schemaPrefix}peticion_evaluacion WHERE titulo IS
      NOT NULL</sql>

    <dropColumn columnName="titulo" tableName="peticion_evaluacion" />

    <!-- Resumen -->
    <createTable tableName="peticion_evaluacion_resumen">
      <column name="peticion_evaluacion_id" type="BIGINT">
        <constraints nullable="false" />
      </column>
      <column name="lang" type="VARCHAR(2)">
        <constraints nullable="false" />
      </column>
      <column name="value_" type="CLOB">
        <constraints nullable="false" />
      </column>
    </createTable>

    <addPrimaryKey tableName="peticion_evaluacion_resumen"
      columnNames="peticion_evaluacion_id, lang" />

    <addForeignKeyConstraint baseColumnNames="peticion_evaluacion_id"
      baseTableName="peticion_evaluacion_resumen"
      constraintName="FK_PETICIONEVALUACIONRESUMEN_PETICIONEVALUACION" deferrable="false"
      initiallyDeferred="false"
      referencedColumnNames="id" referencedTableName="peticion_evaluacion" validate="true" />

    <sql>INSERT INTO ${schemaPrefix}peticion_evaluacion_resumen(peticion_evaluacion_id, lang,
      value_) SELECT id, '${defaultLang}', resumen FROM ${schemaPrefix}peticion_evaluacion WHERE
      resumen IS NOT NULL</sql>

    <dropColumn columnName="resumen" tableName="peticion_evaluacion" />

    <!-- Otro Valor Social -->
    <createTable tableName="peticion_evaluacion_otrovalorsocial">
      <column name="peticion_evaluacion_id" type="BIGINT">
        <constraints nullable="false" />
      </column>
      <column name="lang" type="VARCHAR(2)">
        <constraints nullable="false" />
      </column>
      <column name="value_" type="VARCHAR(2000)">
        <constraints nullable="false" />
      </column>
    </createTable>

    <addPrimaryKey tableName="peticion_evaluacion_otrovalorsocial"
      columnNames="peticion_evaluacion_id, lang" />

    <addForeignKeyConstraint baseColumnNames="peticion_evaluacion_id"
      baseTableName="peticion_evaluacion_otrovalorsocial"
      constraintName="FK_PETICIONEVALUACIONOTROVALORSOCIAL_PETICIONEVALUACION" deferrable="false"
      initiallyDeferred="false"
      referencedColumnNames="id" referencedTableName="peticion_evaluacion" validate="true" />

    <sql>INSERT INTO ${schemaPrefix}peticion_evaluacion_otrovalorsocial(peticion_evaluacion_id,
      lang, value_) SELECT id, '${defaultLang}', otro_valor_social FROM
      ${schemaPrefix}peticion_evaluacion WHERE otro_valor_social IS NOT NULL</sql>

    <dropColumn columnName="otro_valor_social" tableName="peticion_evaluacion" />

    <!-- Objetivos -->
    <createTable tableName="peticion_evaluacion_objetivos">
      <column name="peticion_evaluacion_id" type="BIGINT">
        <constraints nullable="false" />
      </column>
      <column name="lang" type="VARCHAR(2)">
        <constraints nullable="false" />
      </column>
      <column name="value_" type="CLOB">
        <constraints nullable="false" />
      </column>
    </createTable>

    <addPrimaryKey tableName="peticion_evaluacion_objetivos"
      columnNames="peticion_evaluacion_id, lang" />

    <addForeignKeyConstraint baseColumnNames="peticion_evaluacion_id"
      baseTableName="peticion_evaluacion_objetivos"
      constraintName="FK_PETICIONEVALUACIONOBJETIVOS_PETICIONEVALUACION" deferrable="false"
      initiallyDeferred="false"
      referencedColumnNames="id" referencedTableName="peticion_evaluacion" validate="true" />

    <sql>INSERT INTO ${schemaPrefix}peticion_evaluacion_objetivos(peticion_evaluacion_id, lang,
      value_) SELECT id, '${defaultLang}', objetivos FROM ${schemaPrefix}peticion_evaluacion WHERE
      objetivos IS NOT NULL</sql>

    <dropColumn columnName="objetivos" tableName="peticion_evaluacion" />

    <!-- Diseño Metodologico -->
    <createTable tableName="peticion_evaluacion_dismetodologico">
      <column name="peticion_evaluacion_id" type="BIGINT">
        <constraints nullable="false" />
      </column>
      <column name="lang" type="VARCHAR(2)">
        <constraints nullable="false" />
      </column>
      <column name="value_" type="CLOB">
        <constraints nullable="false" />
      </column>
    </createTable>

    <addPrimaryKey tableName="peticion_evaluacion_dismetodologico"
      columnNames="peticion_evaluacion_id, lang" />

    <addForeignKeyConstraint baseColumnNames="peticion_evaluacion_id"
      baseTableName="peticion_evaluacion_dismetodologico"
      constraintName="FK_PETICIONEVALUACIONDISMETODOLOGICOS_PETICIONEVALUACION" deferrable="false"
      initiallyDeferred="false"
      referencedColumnNames="id" referencedTableName="peticion_evaluacion" validate="true" />

    <sql>INSERT INTO ${schemaPrefix}peticion_evaluacion_dismetodologico(peticion_evaluacion_id,
      lang, value_) SELECT id, '${defaultLang}', dis_metodologico FROM
      ${schemaPrefix}peticion_evaluacion WHERE dis_metodologico IS NOT NULL</sql>

    <dropColumn columnName="dis_metodologico" tableName="peticion_evaluacion" />
  </changeSet>

  <!-- Tarea -->
  <changeSet author="user (generated)" id="00.07.00-7">
    <!-- Nombre -->
    <createTable tableName="tarea_nombre">
      <column name="tarea_id" type="BIGINT">
        <constraints nullable="false" />
      </column>
      <column name="lang" type="VARCHAR(2)">
        <constraints nullable="false" />
      </column>
      <column name="value_" type="VARCHAR(250)">
        <constraints nullable="false" />
      </column>
    </createTable>

    <addPrimaryKey tableName="tarea_nombre" columnNames="tarea_id, lang" />

    <addForeignKeyConstraint baseColumnNames="tarea_id"
      baseTableName="tarea_nombre"
      constraintName="FK_TAREANOMBRE_TAREA" deferrable="false"
      initiallyDeferred="false"
      referencedColumnNames="id" referencedTableName="tarea" validate="true" />

    <sql>INSERT INTO ${schemaPrefix}tarea_nombre(tarea_id, lang, value_) SELECT id,
      '${defaultLang}', tarea FROM ${schemaPrefix}tarea WHERE tarea IS NOT NULL</sql>

    <dropColumn columnName="tarea" tableName="tarea" />

    <!-- Formacion -->
    <createTable tableName="tarea_formacion">
      <column name="tarea_id" type="BIGINT">
        <constraints nullable="false" />
      </column>
      <column name="lang" type="VARCHAR(2)">
        <constraints nullable="false" />
      </column>
      <column name="value_" type="VARCHAR(250)">
        <constraints nullable="false" />
      </column>
    </createTable>

    <addPrimaryKey tableName="tarea_formacion" columnNames="tarea_id, lang" />

    <addForeignKeyConstraint baseColumnNames="tarea_id"
      baseTableName="tarea_formacion"
      constraintName="FK_TAREAFORMACION_TAREA" deferrable="false"
      initiallyDeferred="false"
      referencedColumnNames="id" referencedTableName="tarea" validate="true" />

    <sql>INSERT INTO ${schemaPrefix}tarea_formacion(tarea_id, lang, value_) SELECT id,
      '${defaultLang}', formacion FROM ${schemaPrefix}tarea WHERE formacion IS NOT NULL</sql>

    <dropColumn columnName="formacion" tableName="tarea" />

    <!-- Organismo -->
    <createTable tableName="tarea_organismo">
      <column name="tarea_id" type="BIGINT">
        <constraints nullable="false" />
      </column>
      <column name="lang" type="VARCHAR(2)">
        <constraints nullable="false" />
      </column>
      <column name="value_" type="VARCHAR(250)">
        <constraints nullable="false" />
      </column>
    </createTable>

    <addPrimaryKey tableName="tarea_organismo" columnNames="tarea_id, lang" />

    <addForeignKeyConstraint baseColumnNames="tarea_id"
      baseTableName="tarea_organismo"
      constraintName="FK_TAREAORGANISMO_TAREA" deferrable="false"
      initiallyDeferred="false"
      referencedColumnNames="id" referencedTableName="tarea" validate="true" />

    <sql>INSERT INTO ${schemaPrefix}tarea_organismo(tarea_id, lang, value_) SELECT id,
      '${defaultLang}', organismo FROM ${schemaPrefix}tarea WHERE organismo IS NOT NULL</sql>

    <dropColumn columnName="organismo" tableName="tarea" />
  </changeSet>

</databaseChangeLog>