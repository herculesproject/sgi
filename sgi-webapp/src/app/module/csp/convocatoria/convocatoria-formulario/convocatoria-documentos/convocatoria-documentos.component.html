<section>
  <h2>{{'csp.convocatoria.documentos.title' | translate}}</h2>

  <div class="programa" fxLayout="row" fxLayout.xs="column" fxLayoutGap="10px">
    <div class="arbol" fxFlex>
      <mat-tree [dataSource]="dataSource" [treeControl]="treeControl" class="arbol-tree">
        <mat-tree-node *matTreeNodeDef="let node" matTreeNodeToggle matTreeNodePadding>
          <button mat-icon-button *ngIf="(node.level === 2 && viewMode === 'new')">
            {{node.title}}
          </button>
          <button mat-icon-button *ngIf="(node.level === 2 && viewMode !== 'new' && node !== viewingNode)"
            (click)="showNodeDetails(node)">
            {{node.title}}
            <mat-icon color="primary" class="mat-icon-rtl-mirror">
              {{ 'visibility'}}
            </mat-icon>
          </button>
          <button mat-icon-button *ngIf="(node.level === 2 && viewMode !== 'new' && node === viewingNode)"
            (click)="hideNodeDetails()">
            {{node.title}}
            <mat-icon color="primary" class="mat-icon-rtl-mirror">
              {{ 'visibility_off'}}
            </mat-icon>
          </button>
        </mat-tree-node>
        <mat-tree-node *matTreeNodeDef="let node; when: hasChild" matTreeNodePadding>
          <button mat-icon-button matTreeNodeToggle [attr.aria-label]="'Toggle ' + node.documento?.value?.nombre">
            <mat-icon color="primary" class="mat-icon-rtl-mirror">
              {{treeControl.isExpanded(node) ? 'expand_more' : 'chevron_right'}}
            </mat-icon>
            {{node.title | translate}}
          </button>
        </mat-tree-node>
      </mat-tree>
    </div>

    <!-- Visualizacion crear/editar/detalle -->
    <form [formGroup]="formGroup" class="visualizacion" fxFlex="50" *ngIf="viewMode !== ''">
      <h3 *ngIf="viewMode === 'new'">{{'csp.convocatoria.documentos.documento.title.a√±adir' | translate}}</h3>
      <h3 *ngIf="viewMode === 'edit'">{{'csp.convocatoria.documentos.documento.title.editar' | translate}}</h3>
      <h3 *ngIf="viewMode === 'view'">{{'csp.convocatoria.documentos.documento.title.ver' | translate}}</h3>
      <div fxLayout="column" fxLayout.xs="column" fxLayoutGap="10px">
        <mat-form-field class="input-form">
          <mat-label>{{'csp.convocatoria.documentos.documento.nombre' | translate}}</mat-label>
          <input matInput type="text" placeholder="{{'csp.convocatoria.documentos.documento.nombre' | translate}}"
            formControlName="nombre" required>
          <mat-error *ngIf="formGroup.get('nombre').errors?.required">
            {{'csp.convocatoria.documentos.documento.nombre.error' | translate}}
          </mat-error>
        </mat-form-field>
        <div>
          <mat-form-field class="input-form file-upload" (click)="fileUpload.click()">
            <mat-label>{{'csp.convocatoria.documentos.documento.fichero' | translate}}</mat-label>
            <input type="file" #fileUpload (change)="onSeletectFile($event.target.files)" style="display:none;"
              [disabled]="disableUpload" />
            <input matInput type="text" tabindex="0" #fichero="matInput"
              placeholder="{{'csp.convocatoria.documentos.documento.fichero.selecciona' | translate}}"
              (focus)="fichero.focused = true" (blur)="fichero.focused = false" (keyup.enter)="fileUpload.click()"
              formControlName="fichero" [readonly]="true" required>
            <mat-error *ngIf="formGroup.get('fichero').errors?.required">
              {{'csp.convocatoria.documentos.documento.fichero.error' | translate}}
            </mat-error>
            <mat-icon matSuffix>
              arrow_upward
            </mat-icon>
          </mat-form-field>
          <mat-progress-bar *ngIf="(viewMode === 'new' || viewMode === 'edit') && fileToUpload?.status === 'uploading'"
            [value]="fileToUpload?.progress"></mat-progress-bar>
        </div>
        <mat-form-field class="input-form">
          <mat-label>{{'csp.convocatoria.documentos.documento.fase' | translate}}</mat-label>
          <mat-select placeholder="{{'csp.convocatoria.documentos.documento.fase' | translate}}" formControlName="fase"
            [compareWith]="compareFase">
            <mat-option [value]="null"></mat-option>
            <mat-option *ngFor="let fase of tipoFases$ | async" [value]="fase">{{fase.nombre}}</mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field class="input-form">
          <mat-label>{{'csp.convocatoria.documentos.documento.tipoDocumento' | translate}}</mat-label>
          <mat-select placeholder="{{'csp.convocatoria.documentos.documento.tipoDocumento' | translate}}"
            formControlName="tipoDocumento" [compareWith]="compareTipoDocumento">
            <mat-option [value]="null"></mat-option>
            <mat-option *ngFor="let tipo of tiposDocumento" [value]="tipo">{{tipo.nombre}}</mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field class="input-form">
          <mat-label>{{'csp.convocatoria.documentos.documento.publico' | translate}}</mat-label>
          <mat-select placeholder="{{'csp.convocatoria.documentos.documento.publico' | translate}}"
            formControlName="publico" required>
            <mat-option [value]="true">{{'label.si' | translate }}</mat-option>
            <mat-option [value]="false">{{'label.no' | translate }}</mat-option>
          </mat-select>
          <mat-error *ngIf="formGroup.get('publico').errors?.required">
            {{'csp.convocatoria.documentos.documento.publico.error' | translate}}
          </mat-error>
        </mat-form-field>
        <mat-form-field class="input-form">
          <mat-label>{{'csp.convocatoria.documentos.documento.observaciones' | translate}}</mat-label>
          <textarea matInput type="text"
            placeholder="{{'csp.convocatoria.documentos.documento.observaciones' | translate}}"
            formControlName="observaciones"></textarea>
        </mat-form-field>
      </div>
      <div class="separation-button" *ngIf="group.status$ | async as status">
        <button *ngIf="viewMode === 'view'" mat-button mat-raised-button color="primary" class="rounded"
          [disabled]="!viewingNode.fichero" (click)="downloadFile(viewingNode)">
          <mat-icon>arrow_downward</mat-icon>
          {{'csp.convocatoria.documentos.documento.button.descargarFichero' | translate}}
        </button>
        <button *ngIf="!formPart.readonly && viewMode === 'new' || viewMode === 'edit'" color="accent" mat-button
          mat-raised-button (click)="acceptDetail()"
          [disabled]="!status.complete">{{'botones.aceptar' | translate}}</button>
        <button *ngIf="!formPart.readonly && viewMode === 'new' || viewMode === 'edit'" class="link-cancelar"
          mat-button><span class="underline" (click)="cancelDetail()">{{'botones.cancelar' | translate}}</span></button>
        <button *ngIf="!formPart.readonly && viewMode === 'view'" color="accent" class="rounded" mat-button
          mat-raised-button (click)="switchToEdit()">
          <mat-icon>edit</mat-icon>
          {{'csp.convocatoria.documentos.documento.button.editar'| translate}}
        </button>
        <button *ngIf="!formPart.readonly && viewMode === 'view'" color="warn" class="rounded" mat-button
          mat-raised-button (click)="deleteDetail()">
          <mat-icon>close</mat-icon>
          {{'csp.convocatoria.documentos.documento.button.eliminar' | translate}}
        </button>
      </div>
    </form>
    <!-- FIN Visualizacion crear/editar/detalle -->
  </div>

  <div class="separation-button" *ngIf="!formPart.readonly">
    <button color="three" aria-label="Center Align" mat-button mat-raised-button (click)="switchToNew()">
      <mat-icon color="accent">add_circle</mat-icon>
      {{'csp.convocatoria.documentos.button.anadir'| translate}}
    </button>
  </div>

</section>