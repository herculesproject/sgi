name: Java Service CI

on:
  workflow_call:
    inputs:
      service-name:
        required: true
        type: string
        description: "Name of the service (e.g. sgi-csp-service)"
      sonar-project-key:
        required: true
        type: string
        description: "SonarCloud project key (e.g. herculesproject_sgi_csp-service)"
      sonar-branch-name:
        required: false
        type: string
        default: "main"
        description: "Branch name for SonarQube analysis"
      auth-port:
        required: false
        type: string
        default: "8080"
        description: "Host port to expose sgi-auth container on (default: 8080)"

jobs:
  package:
    name: Package
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: maven

      - name: Package (skip tests)
        working-directory: ${{ inputs.service-name }}
        run: mvn -B package -DskipTests -Pprod

      # Upload packaged artifacts for downstream jobs
      - name: Upload packaged artifacts
        uses: actions/upload-artifact@v4
        with:
          name: packaged-${{ inputs.service-name }}
          path: ${{ inputs.service-name }}/target
          retention-days: 1

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: package
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: maven

      - name: Download packaged artifacts
        uses: actions/download-artifact@v4
        with:
          name: packaged-${{ inputs.service-name }}
          path: ${{ inputs.service-name }}/target

      - name: Read project version
        id: version
        run: echo "VERSION=$(cat VERSION | tr -d '[:space:]')" >> $GITHUB_OUTPUT

      - name: Start-up SGI-Auth for Tests
        run: docker run --rm --name sgi-auth
          -e KEYCLOAK_USER=test
          -e KEYCLOAK_PASSWORD=test
          -e PROXY_ADDRESS_FORWARDING=true
          -e KEYCLOAK_IMPORT=/realm/sgi-realm.json
          -p ${{ inputs.auth-port }}:8080
          -d herculesproject/sgi-auth:${{ steps.version.outputs.VERSION }}

      - name: Start-up PostgreSQL for Tests
        run: docker run --rm --name postgres
          -e POSTGRES_USER=postgres
          -e POSTGRES_PASSWORD=admin
          -e POSTGRES_DB=db
          -p 5432:5432
          -d postgres:12

      - name: Wait for services to be ready
        run: sleep 30s
        shell: bash

      - name: Test
        working-directory: ${{ inputs.service-name }}
        run:
          mvn -B test -Dmaven.javadoc.skip=true -Dspring.profiles.active=test-postgres
          -Dspring.datasource.url=jdbc:postgresql://localhost:5432/db
          -Dspring.security.oauth2.client.provider.keycloak.issuer-uri=http://localhost:${{ inputs.auth-port }}/auth/realms/sgi

      - name: Stop containers
        if: always()
        run: |
          docker stop postgres || true
          docker stop sgi-auth || true

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: package
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: maven

      - name: Download packaged artifacts
        uses: actions/download-artifact@v4
        with:
          name: packaged-${{ inputs.service-name }}
          path: ${{ inputs.service-name }}/target

      - name: Read project version
        id: version
        run: echo "VERSION=$(cat VERSION | tr -d '[:space:]')" >> $GITHUB_OUTPUT

      - name: Start-up SGI-Auth for Tests
        run: docker run --rm --name sgi-auth
          -e KEYCLOAK_USER=test
          -e KEYCLOAK_PASSWORD=test
          -e PROXY_ADDRESS_FORWARDING=true
          -e KEYCLOAK_IMPORT=/realm/sgi-realm.json
          -p ${{ inputs.auth-port }}:8080
          -d herculesproject/sgi-auth:${{ steps.version.outputs.VERSION }}

      - name: Start-up PostgreSQL for Integration Tests
        run: docker run --rm --name postgres
          -e POSTGRES_USER=postgres
          -e POSTGRES_PASSWORD=admin
          -e POSTGRES_DB=db
          -p 5432:5432
          -d postgres:12

      - name: Wait for services to be ready
        run: sleep 30s
        shell: bash

      - name: Integration Test
        working-directory: ${{ inputs.service-name }}
        run: mvn -B post-integration-test failsafe:verify
          -DskipUnitTests
          -Dmaven.javadoc.skip=true
          -Dspring.profiles.active=test-postgres
          -Dspring.datasource.url=jdbc:postgresql://localhost:5432/db
          -Dspring.security.oauth2.client.provider.keycloak.issuer-uri=http://localhost:${{ inputs.auth-port }}/auth/realms/sgi

      - name: Stop containers
        if: always()
        run: |
          docker stop postgres || true
          docker stop sgi-auth || true

  sonar:
    name: SonarQube Analysis
    runs-on: ubuntu-latest
    needs: [test, integration-test]
    if: github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: maven

      - name: SonarQube analysis
        working-directory: ${{ inputs.service-name }}
        run: mvn -B verify -DskipTests sonar:sonar
          -Dsonar.host.url=https://sonarcloud.io
          -Dsonar.organization=herculesproject
          -Dsonar.projectKey=${{ inputs.sonar-project-key }}
          -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml
          -Dsonar.branch.name=${{ inputs.sonar-branch-name }}
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  docker:
    name: Docker Build & Push
    runs-on: ubuntu-latest
    needs: [test, integration-test]
    if: github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download packaged artifacts
        uses: actions/download-artifact@v4
        with:
          name: packaged-${{ inputs.service-name }}
          path: ${{ inputs.service-name }}/target

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Prepare docker build
        id: prepare-build
        working-directory: ${{ inputs.service-name }}
        run: |
          mkdir -p target/dependency
          (cd target/dependency; unzip ../*-exec.jar)
          echo "VERSION=$(cat target/dependency/META-INF/build-info.properties | grep build.version | cut -d'=' -f2)" >> $GITHUB_OUTPUT

      - name: Extract metadata (tags, labels) for Docker
        id: docker-metadata
        uses: docker/metadata-action@v5
        with:
          images: herculesproject/${{ inputs.service-name }}
          labels: |
            org.opencontainers.image.title=${{ inputs.service-name }}
          tags: |
            type=semver,pattern={{version}},value=${{ steps.prepare-build.outputs.VERSION }}
            type=sha
            type=raw,value=ci

      - name: Check if Docker image tag already exists
        id: check-docker
        run: |
          VERSION="${{ steps.prepare-build.outputs.VERSION }}"
          IMAGE="herculesproject/${{ inputs.service-name }}"
          if [[ "$VERSION" == *-SNAPSHOT ]]; then
            echo "exists=false" >> $GITHUB_OUTPUT
          else
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://hub.docker.com/v2/repositories/${IMAGE}/tags/${VERSION}")
            if [ "$STATUS" = "200" ]; then
              echo "exists=true" >> $GITHUB_OUTPUT
              echo "::notice::Docker image ${IMAGE}:${VERSION} already exists, skipping push"
            else
              echo "exists=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Build and push Docker image
        if: steps.check-docker.outputs.exists != 'true'
        uses: docker/build-push-action@v6
        with:
          context: "./${{ inputs.service-name }}"
          push: true
          tags: ${{ steps.docker-metadata.outputs.tags }}
          labels: ${{ steps.docker-metadata.outputs.labels }}

  deploy-central:
    name: Deploy to Maven Central
    runs-on: ubuntu-latest
    needs: [test, integration-test]
    if: github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK to deploy on Central
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          server-id: central
          server-username: MAVEN_USERNAME
          server-password: MAVEN_CENTRAL_TOKEN
          gpg-private-key: ${{ secrets.GPG_PRIVATE_KEY }}
          gpg-passphrase: MAVEN_GPG_PASSPHRASE

      - name: Check if artifact already exists in Maven Central
        id: check-maven
        run: |
          VERSION=$(cat VERSION | tr -d '[:space:]')
          if [[ "$VERSION" == *-SNAPSHOT ]]; then
            echo "exists=false" >> $GITHUB_OUTPUT
          else
            URL="https://repo1.maven.org/maven2/io/github/herculesproject/sgi/${{ inputs.service-name }}/${VERSION}/${{ inputs.service-name }}-${VERSION}.pom"
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL")
            if [ "$STATUS" = "200" ]; then
              echo "exists=true" >> $GITHUB_OUTPUT
              echo "::notice::${{ inputs.service-name }}:${VERSION} already exists in Maven Central, skipping deploy"
            else
              echo "exists=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Deploy to Central
        if: steps.check-maven.outputs.exists != 'true'
        working-directory: ${{ inputs.service-name }}
        run: |
          mvn -B deploy -P deployToCentral -DskipTests 2>&1 | tee deploy.log || {
            if grep -q "already exists" deploy.log; then
              echo "::notice::Artifact already published in Maven Central, skipping"
            else
              exit 1
            fi
          }
        env:
          MAVEN_USERNAME: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          MAVEN_CENTRAL_TOKEN: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
          MAVEN_GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
